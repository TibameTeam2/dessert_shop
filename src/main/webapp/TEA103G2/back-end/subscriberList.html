<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>嗜甜-訂閱管理</title>

  <!-- Favicon -->
  <link rel="shortcut icon" href="assets/images/favicon.ico" />
  <link rel="stylesheet" href="assets/css/backend-plugin.min.css">
  <link rel="stylesheet" href="assets/css/backend.css?v=1.0.0">
  <link rel="stylesheet" href="assets/vendor/@fortawesome/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="assets/vendor/line-awesome/dist/line-awesome/css/line-awesome.min.css">
  <link rel="stylesheet" href="assets/vendor/remixicon/fonts/remixicon.css">

  <!-- Amber CSS Link-->
  <link rel="stylesheet" href="assets/css/liveSupport.css">

  <style>
    table th {
      text-align: center;
    }

    table td {
      text-align: center;
    }

    @media (min-width: 576px) {
      .modal-dialog {
        max-width: 1000px !important;
      }
    }
  </style>

</head>

<body class="">
  <!-- loader Start -->
  <div id="loading">
    <div id="loading-center">
    </div>
  </div>
  <!-- loader END -->
  <!-- Wrapper Start -->
  <div class="wrapper">

    <!--Header-->
    <div class="header"></div>

    <div class="content-page">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-12">
            <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
              <div>
                <h4 class="mb-3">訂閱管理</h4>
              </div>
              <a href="#" class="btn btn-primary add-list" data-toggle="modal" data-target="#addList"><i
                  class="las la-plus mr-3"></i>新增訂閱者</a>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="table-responsive rounded mb-3">
              <table class="data-table table mb-0 tbl-server-info">
                <thead class="bg-white text-uppercase">
                  <tr class="ligth ligth-data">
                    <th>編號</th>
                    <th>日期</th>
                    <th>電子郵件</th>
                    <th>訂閱狀態</th>
                    <th>會員帳號</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody class="ligth-body" id="content">
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Page end  -->
      </div>
      <!-- Wrapper End-->

      <!-- 新增訂閱LightBox -->
      <div class="modal fade" id="addList" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <div class="popup text-left">
                <!--------------------------------------------------------------->

                <div class="container-fluid add-form-list">
                  <div class="row">

                    <div class="col-sm-12">
                      <div class="card" style="margin: 15px 0 15px 0">

                        <div class="card-header d-flex justify-content-between">
                          <div class="header-title">
                            <h4 class="card-title" style="margin-left:380px">新增訂閱者</h4>
                          </div>
                        </div>

                        <div class="card-body">
                          <form id="addSubscriber_form" action="subscriberList.html" data-toggle="validator"
                            enctype="multipart/form-data">
                            <div class="row">

                              <div class="col-md-6">
                                <div class="form-group">
                                  <label class="add_subscriber_email_label">訂閱者信箱</label>
                                  <input type="text" name="subscriber_email" class="form-control add_subscriber_email"
                                    placeholder="" data-errors="請輸入信箱.." required>
                                  <div class="help-block with-errors"></div>
                                </div>
                              </div>

                              <div class="col-md-6 ">
                                <div class="form-group ">
                                  <label>會員帳號</label>
                                  <select name="member_account" class="form-control add_member_account"
                                    data-style="py-0">
                                    <option value="">請選擇會員</option>
                                    <option value="x">非會員</option>
                                  </select>
                                </div>
                              </div>

                              <button type="submit" id="addSubscriber" class="btn btn-primary mr-2"
                                style="margin-left:700px">新增通知</button>
                              <button type="reset" class="btn btn-danger form_reset">清除內容</button>
                            </div>
                          </form>
                        </div>

                      </div>
                    </div>
                  </div>
                  <!-- Page end  -->
                </div>

                <!--------------------------------------------------------------->
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- 更新訂閱LightBox -->
      <div class="modal fade" id="updateList" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <div class="popup text-left">
                <!--------------------------------------------------------------->

                <div class="container-fluid add-form-list">
                  <div class="row">

                    <div class="col-sm-12">
                      <div class="card" style="margin: 15px 0 15px 0">

                        <div class="card-header d-flex justify-content-between">
                          <div class="header-title">
                            <h4 class="card-title" style="margin-left:380px">更新訂閱者資訊</h4>
                          </div>
                        </div>

                        <div class="card-body">
                          <form id="updateSubscriber_form" action="subscriberList.html" data-toggle="validator"
                            enctype="multipart/form-data">

                            <div class="row">

                              <div class="col-md-6">
                                <div class="form-group">
                                  <label></label>通知編號</label>
                                  <input name="subscriber_id" type="text" class="form-control update_subscriber_id"
                                    placeholder="" readonly style="background-color:white; border: none;">
                                </div>
                              </div>


                              <div class="col-md-6">
                                <div class="form-group ">
                                  <label>會員帳號</label>
                                  <select name="member_account" class="form-control update_member_account"
                                    data-style="py-0">
                                    <option value="x">非會員</option>
                                  </select>
                                </div>
                              </div>

                              <div class="col-md-6">
                                <div class="form-group">
                                  <label>訂閱者信箱</label>
                                  <input type="text" name="subscriber_email"
                                    class="form-control update_subscriber_email" placeholder="" data-errors="請輸入信箱.."
                                    required>
                                  <div class="help-block with-errors"></div>
                                </div>
                              </div>

                              <div class="col-md-6">
                                <div class="form-group ">
                                  <label>訂閱狀態</label>
                                  <select name="subscriber_status"
                                    class="selectpicker form-control update_subscriber_status" data-style="py-0">
                                    <option value="0">取消訂閱</option>
                                    <option value="1">加入訂閱</option>
                                  </select>
                                </div>
                              </div>

                              <button type="submit" id="updateSubscriber" class="btn btn-primary mr-2"
                                style="margin-left:850px">更新</button>
                          </form>
                        </div>

                      </div>
                    </div>
                  </div>
                  <!-- Page end  -->
                </div>

                <!--------------------------------------------------------------->
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Backend Bundle JavaScript -->
      <script src="assets/js/backend-bundle.min.js"></script>
      <!-- Table Treeview JavaScript -->
      <script src="assets/js/table-treeview.js"></script>
      <!-- Chart Custom JavaScript -->
      <script src="assets/js/customizer.js"></script>
      <!-- Chart Custom JavaScript -->
      <script async src="assets/js/chart-custom.js"></script>
      <!-- app JavaScript -->
      <script src="assets/js/app.js"></script>
      <!-- Timestamp轉成指定格式 -->
      <script src="assets/js/moment.js"></script>


      <script>
        /*--------------- 載入Header區塊 ---------------*/
        $(document).ready(function () {
          $('.header').load('header.html');
        })

        /*----------------- 進頁面先初始化表格 -----------------*/
        let table = $(".data-table").DataTable()
        table.destroy();
        table = $(".data-table")
          .DataTable({
            "lengthMenu": [10,
              15, 20, 25
            ], //顯示XX像結果
            "language": {
              "processing": "處理中...",
              "loadingRecords": "載入中...",
              "lengthMenu": "顯示 _MENU_ 項結果",
              "zeroRecords": "沒有符合的結果",
              "info": "顯示第 _START_ 至 _END_ 筆結果，共 _TOTAL_ 筆",
              "infoEmpty": "顯示第 0 至 0 筆結果，共 0 筆",
              "infoFiltered": "(從 _MAX_ 項結果中過濾)",
              "infoPostFix": "",
              "search": "搜尋:",
              "paginate": {
                "first": "第一頁",
                "previous": "上一頁",
                "next": "下一頁",
                "last": "最後一頁"
              },
              "aria": {
                "sortAscending": ": 升冪排列",
                "sortDescending": ": 降冪排列"
              }
            },
            "columnDefs": [{
              "targets": [0], //欄位從0開始算
              "visible": true, //欄位是否顯示 預設是true
              "orderable": true, //是否可以排序
              "width": "5%"
            }, {
              "targets": [1],
              "visible": true,
              "orderable": true,
              "width": "15%"
            }, {
              "targets": [2],
              "visible": true,
              "orderable": false,
              "width": "2%",
              "className": "dt-body-left",
              "width": "20%"
            }, {
              "targets": [3],
              "visible": true,
              "orderable": false,
              "width": "10%",
              render: function (data, type, row) {
                switch (data) {
                  case 0:
                    return "未訂閱";
                  case 1:
                    return "已訂閱";
                  default:
                    return data;
                }
              }
            }, {
              "targets": [4],
              "visible": true,
              "orderable": false,
              "width": "10%",
              render: function (data, type, row) {
                switch (data) {
                  case null:
                    return "非會員";
                  default:
                    return data;
                }
              }
            }, {
              "targets": [5],
              "visible": true,
              "orderable": true,
              "width": "10%"
            }]
          })
        getAllSubscriber();
        $('.add_subscriber_email').blur(checkEmail);

        /*----------------- 選單選項 -----------------*/
        $.post("/dessert_shop/member/backend_getAll", function (data) {
          if (data.flag) {
            for (var i = 0; i < data.data.length; i++) {
              console.log(data.data[i].member_account);
              $('.add_member_account').append(`<option value="` + data.data[i].member_account + `">` + data.data[i].member_account + `</option>`)
              $('.update_member_account').append(`<option value="` + data.data[i].member_account + `">` + data.data[i].member_account + `</option>`)
            }
            $('.add_member_account').selectpicker('refresh');
            $('.update_member_account').selectpicker('refresh');

          } else { }
        });

        /*------------------- 新增通知 ************************/
        $('#addSubscriber').on("click", function (e) {
          e.preventDefault();

          let form = $("#addSubscriber_form")[0];
          let data = new FormData(form);

          $.post("/dessert_shop/subscriberList/backend_addSubscriberList", $("#addSubscriber_form").serialize(), function (data) {

            console.log(data);

            if (data.flag) {
              Swal.fire({
                title: data.msg,
                text: "新增成功",
                icon: "success"
              });
              getAllSubscriber();
              $("#addList").modal('hide');
              $("#addSubscriber_form").trigger("reset");
              $('.add_member_account').trigger("change");
            } else {
              Swal.fire({
                title: data.msg,
                text: "請確認郵件格式與會員需選擇",
                icon: "error"
              })
            }
          });
        });



        /*-------------------- 更新通知 --------------------*/
        $('tbody').on("click", 'a.edit', function () {

          let table = $('.data-table').DataTable();
          let data = table.row($(this).closest('tr')).data();

          $('.update_subscriber_id').val(data[0]);
          $('.update_subscriber_email').val(data[2]);
          getUpdate_Statue(data[3]);
          // $('.update_member_account').val(data[4]);
          getMember(data[4]);

          console.log($('.update_member_account').val());
        });



        $('#updateSubscriber').on("click", function (e) {
          e.preventDefault();
          console.log("按下更新");

          let form = $("#updateSubscriber_form")[0];
          let data = new FormData(form);

          $.post("/dessert_shop/subscriberList/backend_update", $("#updateSubscriber_form").serialize(), function (data) {

            console.log("發送新增請求")

            if (data.flag) {
              Swal.fire({
                title: data.msg,
                text: "新增成功",
                icon: "success"
              });
              getAllSubscriber();
              $("#addList").modal('hide');
              $("#addSubscriber_form").trigger("reset");
              $('.add_member_account').trigger("change");
            } else {
              Swal.fire({
                title: data.msg,
                text: "新增失敗",
                icon: "error"
              })
            }
          });
        });

        /*-------------------- 刪除通知 --------------------*/
        $('tbody').on("click", 'a.delete', function () {

          let table = $(".data-table").DataTable()
          let data = table.row($(this).closest('tr')).data()

          $.post("/dessert_shop/subscriberList/backend_delete", { "subscriber_id": data[0] }, function (data) {
            console.log(data);
            if (data.flag) {
              getAllSubscriber();
              Swal.fire({
                title: data.msg,
                text: "刪除成功",
                icon: "success"
              });
            } else {
              Swal.fire({
                title: data.msg,
                text: "刪除失敗",
                icon: "error"
              })
            }
          });
        });


        /*-------------------- Function 放置區 --------------------*/

        function getAllSubscriber() {

          let action = `
<div class="d-flex align-items-center list-action">                                                
<a class="badge bg-success mr-3 edit" data-toggle="modal" data-target="#updateList" data-placement="top " title=" " data-original-title="Edit " href="# "><i class="ri-pencil-line mr-0 "></i></a>                                              
<a class="badge bg-warning mr-0 delete" data-toggle="tooltip " data-placement="top " title="" data-original-title="Delete " href="# "><i class="ri-delete-bin-line mr-0 "></i></a>                                            
</div>`

          $.post("/dessert_shop/subscriberList/backend_getAllSubscriberList", function (data) {

            if (data.flag) {
              let table = $(".data-table").DataTable()
              table.clear().draw();
              for (let i = 0; i < data.data.length; i++) {
                table.row.add([
                  data.data[i].subscriber_id,
                  moment(data.data[i].subscriber_date).format('YYYY-MM-DD'),
                  data.data[i].subscriber_email,
                  data.data[i].subscriber_status,
                  data.data[i].member_account,
                  action
                ]).draw(false);
              }

            } else { }
          });
        }

        function checkEmail() {

          console.log("檢查郵件");
          let addEmail = $.trim($('.add_subscriber_email').val());
          let regEmail = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;

          let flag = regEmail.test(addEmail);
          if (flag) {
            $.post("/dessert_shop/subscriberList/backend_checkEmail", { "subscriber_email": addEmail }, function (data) {
              if (data.flag) {
                console.log(data.flag + "Email可使用");
                $(".add_subscriber_email_label").html("訂閱者信箱");
              } else {
                console.log(data.flag);
                $(".add_subscriber_email").css("border", "1px solid #E08DB4");
                $(".add_subscriber_email_label").html("訂閱者信箱*&nbsp&nbsp&nbsp&nbsp" + data.msg);

              }

            });
          }
        }


        function getUpdate_Statue(status) {
          switch (status) {
            case "取消訂閱":
              $('.update_subscriber_status').val("0")
              break;
            case "加入訂閱":
              $('.update_subscriber_status').val("1");
              break;
            default:
              $('.update_subscriber_status').val(status);
              break;
          }
          $('.update_subscriber_status').selectpicker('refresh');
        }


        function getMember(member) {
          switch (member) {
            case null:
              $('.update_member_account').val("x")
              break;
            default:
              $('.update_member_account').val(member);
              break;
          }
          $('.update_member_account').selectpicker('refresh');
        }

        $('.form_reset').on("click", function () {
          $('.add_member_account').trigger("change");
        })
      </script>

</body>

</html>