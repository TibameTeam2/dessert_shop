<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Amino - Organic & Multipurpose Bootstrap 5 Template</title>
    <meta name="robots" content="noindex, follow" />
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png">

    <!-- CSS
	============================================ -->

    <!-- Icon Font CSS -->
    <link rel="stylesheet" href="assets/css/plugins/ionicons.min.css">
    <link rel="stylesheet" href="assets/css/plugins/line-awesome.min.css">
    <link rel="stylesheet" href="assets/css/plugins/fontawesome.min.css">

    <!-- Plugins CSS -->
    <link rel="stylesheet" href="assets/css/plugins/animate.min.css">
    <link rel="stylesheet" href="assets/css/plugins/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/plugins/nice-select.css">
    <link rel="stylesheet" href="assets/css/plugins/select2.min.css">
    <link rel="stylesheet" href="assets/css/plugins/jquery-ui.min.css">
    <link rel="stylesheet" href="assets/css/plugins/magnific-popup.css">

    <!-- Main Style CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/custom.css">

    <!--====== Use the minified version files listed below for better performance and remove the files listed above ======-->
    <!-- <link rel="stylesheet" href="assets/css/vendor/plugins.min.css">
    <link rel="stylesheet" href="assets/css/style.min.css"> -->
    <!-- Modernizer & jQuery JS -->
    <script src="assets/js/vendor/modernizr-3.11.2.min.js"></script>
    <script src="assets/js/vendor/jquery-3.5.1.min.js"></script>
    <script src="assets/js/vendor/jquery.waitforimages.min.js"></script>
    <script src="assets/js/plugins/sweetalert2.all.min.js"></script>
</head>

<body>
    <!-- Loading Progress
============================================= -->
    <div id="loading-progress">
        <a class="logo" href="#">
            <img src="assets/images/logo.jpg" data-logo-alt="images/files/logo-header.png" alt="">
            <!--        <h3><span class="colored">Astron</span></h3>-->
            <!--        <span>HTML Template</span>-->
        </a>
        <!-- .logo end -->
        <div class="lp-content">
            <div class="lp-counter">
                Loading
                <div id="lp-counter">0%</div>
            </div>
            <!-- .lp-counter end -->
            <div class="lp-bar">
                <div id="lp-bar"></div>
            </div>
            <!-- .lp-bar end -->
        </div>
        <!-- .lp-content end -->
    </div>
    <!-- #loading-progress end -->


    <div class="main-wrapper">

        <!--Header-->
        <div class="header"></div>

        <!--Page Banner Start-->
        <div class="section page-banner-wrapper bg-cover" style="background-image: url(assets/images/page-banner.jpg);">
            <div class="container">
                <div class="page-banner">
                    <ul class="breadcrumb justify-content-center">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item active">Login</li>
                    </ul>
                </div>
            </div>
        </div>
        <!--Page Banner Start-->

        <!-- Login Section Start -->
        <div class="section section-padding-02 mt-n1">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <!-- Login & Register Start -->
                        <div class="login-register-wrapper">
                            <h4 class="title">登入</h4>
                            <form id="login_form" action="#">
                                <div class="single-form">
                                    <label class="form-label">帳號 *</label>
                                    <input type="text" class="form-control" name="member_account">
                                </div>
                                <div class="single-form">
                                    <label class="form-label">密碼</label>
                                    <input type="password" class="form-control" name="member_password">
                                </div>
                                <!--                                <div class="form-check">-->
                                <!--                                    <input type="checkbox" class="form-check-input" id="remember">-->
                                <!--                                    <label class="form-check-label" for="remember">記住我</label>-->
                                <!--                                </div>-->
                                <div class="single-form">
                                    <button class="btn btn-primary btn-hover-dark">登入</button>
                                </div>
                            </form>
                            <p><a href="javascript:void(0)" id="forgetPassword">忘記密碼?</a></p>
                            <p>沒有帳號? <a href="register.html">點此註冊</a></p>
                        </div>
                        <!-- Login & Register End -->
                    </div>
                </div>
            </div>
        </div>
        <!-- Login Section End -->

        <!--Footer-->
        <div class="footer"></div>

    </div>


    <!-- JS
============================================ -->


    <!-- Bootstrap JS -->
    <script src="assets/js/plugins/popper.min.js"></script>
    <script src="assets/js/plugins/bootstrap.min.js"></script>

    <!-- Plugins JS -->
    <script src="assets/js/plugins/swiper-bundle.min.js"></script>
    <script src="assets/js/plugins/jquery.nice-select.min.js"></script>
    <script src="assets/js/plugins/select2.min.js"></script>
    <script src="assets/js/plugins/jquery-ui.min.js"></script>
    <script src="assets/js/plugins/jquery.magnific-popup.min.js"></script>
    <script src="assets/js/plugins/jquery.zoom.min.js"></script>
    <script src="assets/js/plugins/ajax-contact.js"></script>

    <!--====== Use the minified version files listed below for better performance and remove the files listed above ======-->
    <!-- <script src="assets/js/plugins.min.js"></script> -->


    <!-- Main JS -->
    <script src="assets/js/main.js"></script>


    <script>
        $(document).ready(function() {
            $('.header').load('header.html')
            $('.footer').load('footer.html')

        })

        $("body").waitForImages({
            finished: function() {
                setTimeout(function() {
                    $(".lp-content, #loading-progress .logo").css({
                        opacity: 0
                    })
                    $("#loading-progress").addClass("hide-it"),
                        setTimeout(function() {
                            $(".banner-parallax > .bg-element, .banner-parallax > .overlay-pattern").addClass("appeared")
                        }, 1000)
                }, 0)
            },
            each: function(a, t, e) {
                var n = Math.floor((a + 1) / t * 100);
                $("#lp-counter").animate({
                    $this: n
                }, {
                    duration: 150,
                    easing: "",
                    queue: !1,
                    step: function(a) {
                        var t = Math.round(a);
                        $("#lp-counter").text(t + "%")
                    }
                }), $("#lp-bar").animate({
                    width: n + "%"
                }, 0)
            },
            waitForAll: !0
        });

        $(function() {
            $.get("/dessert_shop/member/isLogin", {}, function(data) {
                console.log(data);
                if (data.flag) {
                    // alert("帳號:" + data.data.member_account + "\n姓名:" + data.data.member_name + "\n密碼:" + data.data.member_password);
                    //              console.log(data.data);
                    console.log("帳號:" + data.data.member_account + "\n姓名:" + data.data.member_name + "\n密碼:" + data.data.member_password);
                    // if(data.redirect)
                    //     location.href = data.redirect;
                } else {}
            });

            //會員點選email信，啟動帳號
            let activeCode = getParameter("activeCode"); //取不到值時會是null
            // console.log(activeCode);
            if (activeCode != null) {
                $.post("/dessert_shop/member/emailActive?", "activeCode=" + activeCode, function(data) {
                    console.log(data);
                    if (data.flag) {
                        Swal.fire({
                            title: data.msg,
                            text: '',
                            icon: 'success'
                        }).then(function() {
                            history.replaceState(null, null, "login.html");
                        });
                    } else {
                        Swal.fire({
                            title: data.msg,
                            text: '',
                            icon: 'error'
                        }).then(function() {
                            history.replaceState(null, null, "login.html");
                        });
                    }
                });
            }

            //會員點選email信，忘記密碼  未完成
            let resetPasswordCode = getParameter("resetPasswordCode"); //取不到值時會是null
            console.log(resetPasswordCode);
            if (resetPasswordCode != null) {
                $.post("/dessert_shop/member/resetPassword?", "isValid=1&resetPasswordCode=" + resetPasswordCode, async function(data) {
                    if (data.flag) { //重置碼合法，準備輸入密碼
                        const {
                            value: password
                        } = await Swal.fire({
                                title: '重置密碼',
                                html: '<input type="password" id="swal-input1" class="swal2-input" placeholder="密碼">' +
                                    '<input type="password" id="swal-input2" class="swal2-input" placeholder="確認密碼">',
                                confirmButtonClass: 'password',
                                confirmButton: 'false',
                                preConfirm: () => {
                                    return [
                                        document.getElementById('swal-input1').value,
                                        document.getElementById('swal-input2').value
                                    ]
                                }
                            })
                            //以下開始重置密碼，發請求給伺服器
                        if (password) {
                            console.log("password=" + password[0]);
                            $.post("/dessert_shop/member/resetPassword?", "resetPasswordCode=" + resetPasswordCode + "&password=" + password[0], async function(data) {
                                console.log(data);
                                if (data.flag) {
                                    Swal.fire({
                                        title: data.msg,
                                        text: '',
                                        icon: 'success'
                                    }).then(function() {
                                        history.replaceState(null, null, "login.html");
                                    });
                                } else {
                                    Swal.fire({
                                        title: data.msg,
                                        text: '',
                                        icon: 'error'
                                    }).then(function() {
                                        history.replaceState(null, null, "login.html");
                                    });
                                }
                            });

                            // Swal.fire(JSON.stringify(formValues))
                        }
                    } else { //重置碼非法
                        Swal.fire({
                            title: data.msg,
                            text: '',
                            icon: 'error'
                        })
                    }
                });
            }

            // 重置密碼彈出視窗，檢查兩次密碼是否相同
            $("body").on("blur", "#swal-input2", function(e) {
                let input1 = $("#swal-input1").val()
                let input2 = $("#swal-input2").val()
                    // console.log( input1);
                    // console.log( input2);
                if (input1 !== input2) {
                    $(".swal2-confirm").text("密碼不一致!");
                    $("#swal-input1").css("border", "2px solid red");
                    $("#swal-input2").css("border", "2px solid red");
                    $(".swal2-confirm").prop('disabled', true);
                } else {
                    if (input1 == '' || input2 == '') {
                        $(".swal2-confirm").text("密碼不得為空!");
                        $("#swal-input1").css("border", "2px solid red");
                        $("#swal-input2").css("border", "2px solid red");
                        $(".swal2-confirm").prop('disabled', true);
                        return;
                    }
                    $("#swal-input1").css("border", "3px solid green");
                    $("#swal-input2").css("border", "3px solid green");
                    $(".swal2-confirm").text("OK");
                    $(".swal2-confirm").prop('disabled', false);
                }
            });

            function getParameter(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param); //取不到值時會是null
            }

            //點擊忘記密碼 彈出視窗
            $("#forgetPassword").click(async function() {
                let {
                    value: email
                } = await Swal.fire({
                    title: '忘記密碼',
                    input: 'email',
                    inputLabel: '請輸入帳號信箱',
                    // inputPlaceholder: 'Enter your email address',
                    showCancelButton: true
                })
                if (email) {
                    Swal.fire({
                        title: '重置密碼的連結已發送至\n' + email,
                        text: '',
                        icon: "success"
                    })

                    $.post("/dessert_shop/member/forgetPassword?", "email=" + email, function(data) {
                        // if (data.flag) {
                        //     Swal.fire({
                        //         title: data.msg,
                        //         text: '',
                        //         icon: 'success'
                        //     }).then(function () {
                        //         location.href = data.redirect;
                        //     });
                        // } else {
                        //     Swal.fire({
                        //         title: data.msg,
                        //         text: '',
                        //         icon: 'error'
                        //     })
                        // }
                    });


                }
            })


            //表單送出時
            $("#login_form").submit(function() {
                //表單提交時檢查所有屬性合法
                // if(checkUsername() && checkPassword() && checkEmail()){
                //發送ajax請求，送出表單資料
                console.log($("#login_form").serialize());
                $.post("/dessert_shop/member/login", $(this).serialize(), function(data) {
                    //處理伺服器回應的資料  data  {flag:true,errorMsg:"註冊成功!!!"}
                    if (data.flag) {
                        // 註冊成功後跳轉頁面
                        // location.href="register_ok.html";
                        // alert("註冊成功!!!");
                        alert(data.msg);
                        if (data.redirect)
                            location.href = data.redirect;
                    } else {
                        // 註冊失敗 彈出視窗
                        // $("#errorMsg").html(data.errorMsg);
                        // alert("註冊失敗!!!");
                        alert(data.msg);
                    }
                });

                //2.不跳轉頁面，等資料回來會做跳轉
                return false;
                //如果為true，表單提交，如果為false，不提交
                //在這裡不管怎樣都是false，因為跳轉的功能在ajax中實現了
            });
        });
    </script>
</body>

</html>