<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>嗜甜-結帳</title>
    <meta name="robots" content="noindex, follow" />
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png">

    <!-- CSS
	============================================ -->

    <!-- Icon Font CSS -->
    <link rel="stylesheet" href="assets/css/plugins/ionicons.min.css">
    <link rel="stylesheet" href="assets/css/plugins/line-awesome.min.css">
    <link rel="stylesheet" href="assets/css/plugins/fontawesome.min.css">

    <!-- Plugins CSS -->
    <link rel="stylesheet" href="assets/css/plugins/animate.min.css">
    <link rel="stylesheet" href="assets/css/plugins/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/plugins/nice-select.css">
    <link rel="stylesheet" href="assets/css/plugins/select2.min.css">
    <link rel="stylesheet" href="assets/css/plugins/jquery-ui.min.css">
    <link rel="stylesheet" href="assets/css/plugins/magnific-popup.css">

    <!-- Main Style CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/custom.css">

    <!-- 信用卡 -->
    <link href="assets/css/cardstyle.css" rel="stylesheet">

    <!--====== Use the minified version files listed below for better performance and remove the files listed above ======-->
    <!-- <link rel="stylesheet" href="assets/css/vendor/plugins.min.css">
    <link rel="stylesheet" href="assets/css/style.min.css"> -->


    <style>
        .form-container.-on {
            display: none;
        }
    </style>

</head>

<body>
    <!-- Loading Progress 

============================================= -->

    <div id="loading-progress">

        <a class="logo" href="#">

            <img src="assets/images/logo.jpg" data-logo-alt="images/files/logo-header.png" alt="">

            <!--        <h3><span class="colored">Astron</span></h3>-->

            <!--        <span>HTML Template</span>-->

        </a><!-- .logo end -->

        <div class="lp-content">

            <div class="lp-counter">

                Loading

                <div id="lp-counter">0%</div>

            </div><!-- .lp-counter end -->

            <div class="lp-bar">

                <div id="lp-bar"></div>

            </div><!-- .lp-bar end -->

        </div><!-- .lp-content end -->

    </div>

    <!-- #loading-progress end -->


    <div class="main-wrapper">

        <!--Header-->

        <div class="header"></div>

        <!--Page Banner Start-->
        <div class="section page-banner-wrapper bg-cover" style="background-image: url(assets/images/page-banner.jpg);">
            <div class="container">
                <div class="page-banner">
                    <ul class="breadcrumb justify-content-center">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item active">Wishlist</li>
                    </ul>
                </div>
            </div>
        </div>
        <!--Page Banner Start-->

        <!-- Checkout Section Start -->
        <div class="section section-padding-02 mt-n6">

            <div class="container">

                <!-- <div id="css-script-menu"> -->

                <div class="checkout-info mt-30">
                    <h1>購物車結帳</h1>


                    <div class="collapse" id="coupon">
                        <div class="card-body">
                            <form action="#">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="single-form">
                                            <input type="email" placeholder="Coupon code" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="single-form">
                                            <button class="btn btn-primary">Login</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- row開始 -->
                <div class="row">
                    <!-- 左半開始 -->
                    <div class="col-lg-7">

                        <div class="checkout-form">
                            <div class="checkout-title">
                                <h4 class="title">取餐者資訊</h4>
                            </div>

                            <div class="row">

                                <div class="col-sm-12">
                                    <div class="single-form">
                                        <label class="form-label">會員姓名:</label>
                                        <span class="show_name"></span>
                                    </div>
                                </div>

                            </div>
                            <div class="col-sm-12">
                                <div class="single-form">
                                    <label class="form-label">電話:</label>
                                    <span class="show_phone"></span>
                                </div>
                            </div>

                            <div class="col-sm-12">
                                <div class="single-form">
                                    <label class="form-label">電子信箱:</label>
                                    <span class="show_email"></span>
                                </div>
                            </div>



                        </div>
                        <div class="col-sm-12">
                            <div class="single-form">
                                <label class="form-label">其他備註</label>
                                <textarea class="form-control remarks"></textarea>
                            </div>
                        </div>

                        <!-- 付款方式 -->

                        <div class="col-sm-12" style="padding-top: 30px;">
                            <h5>付款方式</h5>

                            <input type="radio" id="pay1" name="payment" value="card"><label for="pay1">線上刷卡</label>
                            <input type="radio" id="pay2" name="payment" value="shop"><label for="pay2">到店付款</label>
                            <input type="radio" id="pay3" name="payment" value="atm"><label for="pay3">匯款</label>

                            <div class="form-container -on">

                                <sapn>請選擇您的信用卡</span>
                                    <span class="card_empty">(您未有任何信用卡)</span>
                                    <div class="card_list" style="overflow: auto;">

                                        <!-- 放信用卡資料 -->

                                    </div>

                                    <div class="field-container">
                                        <label for="cardnumber">卡號</label>
                                        <input id="cardnumber" class="form-control" type="text" pattern="[0-9]*"
                                            inputmode="numeric">
                                        <svg id="ccicon" class="ccicon" width="750" height="471" viewBox="0 0 750 471"
                                            version="1.1" xmlns="http://www.w3.org/2000/svg"
                                            xmlns:xlink="http://www.w3.org/1999/xlink">
                                        </svg>
                                    </div>
                                    <div class="field-container">
                                        <label for="expirationdate">有效期限 (mm/yy)</label>
                                        <input id="expirationdate" class="form-control" type="text" pattern="[0-9]*"
                                            inputmode="numeric">
                                    </div>
                                    <div class="field-container">
                                        <label for="securitycode">安全碼</label>
                                        <input id="securitycode" class="form-control" type="text" pattern="[0-9]*"
                                            inputmode="numeric">
                                    </div>
                                    <div>
                                        <button type="button" class="insert_card" style="float: right;">新增</button>
                                    </div>


                            </div>


                        </div>


                    </div>
                    <!-- 左半結束 -->


                    <!-- 右半開始 -->
                    <div class="col-lg-5">

                        <div class="checkout-order">
                            <div class="checkout-title">
                                <h4 class="title">訂購商品</h4>
                            </div>

                            <div class="checkout-order-table table-responsive">
                                <table class="table cart_table">
                                    <thead>
                                        <tr>
                                            <th class="Product-name">商品</th>
                                            <th class="Product-price">金額</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        <!-- 放購物車資料 -->

                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td class="Product-name">
                                                <p class="total_quantity">合計數量：8</p>
                                            </td>
                                            <td class="Product-price">
                                                <p></p>
                                            </td>
                                        </tr>

                                        <tr>
                                            <td class="Product-name">
                                                <p class="total_price"></p>
                                            </td>
                                            <td class="Product-price">
                                                <p></p>
                                            </td>
                                        </tr>

                                        <tr>
                                            <td class="Product-name">
                                                <p class="coupon_price">優惠金額：0元</p>
                                            </td>
                                            <td class="Product-price">
                                                <p></p>
                                            </td>
                                        </tr>

                                    </tfoot>
                                </table>
                            </div>

                            <div class="checkout-payment">

                                <h3 class="final_price" style="text-align: right; font-weight: bold;"></h3>

                                <div class="checkout-btn">
                                    <a class="btn btn-primary btn-hover-dark d-block setOrder"
                                        data-payment_method="0">確認結帳</a>
                                    <p></p>
                                    <a class="btn btn-primary btn-hover-dark d-block" href="cart.html">回上一頁</a>
                                </div>
                            </div>
                        </div>




                    </div>
                    <!-- 右半結束 -->







                </div>
                <!-- row結束 -->






            </div>


        </div>

        <!-- Checkout Section End -->
        <!-- Shopping Cart Section End -->


        <!--Footer-->

        <div class="footer"></div>



    </div>



    <!-- JS
    ============================================ -->

    <!-- Modernizer & jQuery JS -->
    <script src="assets/js/vendor/modernizr-3.11.2.min.js"></script>
    <script src="assets/js/vendor/jquery-3.5.1.min.js"></script>
    <script src="assets/js/vendor/jquery.waitforimages.min.js"></script>
    <script src="assets/js/plugins/sweetalert2.all.min.js"></script>

    <!-- sweetalert2 -->
    <script src="assets/js/plugins/sweetalert2.all.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="assets/js/plugins/popper.min.js"></script>
    <script src="assets/js/plugins/bootstrap.min.js"></script>

    <!-- Plugins JS -->
    <script src="assets/js/plugins/swiper-bundle.min.js"></script>
    <script src="assets/js/plugins/jquery.nice-select.min.js"></script>
    <script src="assets/js/plugins/select2.min.js"></script>
    <script src="assets/js/plugins/jquery-ui.min.js"></script>
    <script src="assets/js/plugins/jquery.magnific-popup.min.js"></script>
    <script src="assets/js/plugins/jquery.zoom.min.js"></script>
    <script src="assets/js/plugins/ajax-contact.js"></script>

    <!-- 信用卡 -->
    <script src="assets/js/cardimask.min.js"></script>
    <script src="assets/js/cardindex.js"></script>

    <!--====== Use the minified version files listed below for better performance and remove the files listed above ======-->
    <!-- <script src="assets/js/plugins.min.js"></script> -->


    <!-- Main JS -->
    <script src="assets/js/main.js"></script>


    <script>

        $(document).ready(function () {

            $('.header').load('header.html');

            $('.footer').load('footer.html');

        });


        $("body").waitForImages({

            finished: function () {

                setTimeout(function () {

                    $(".lp-content, #loading-progress .logo").css({ opacity: 0 })

                    $("#loading-progress").addClass("hide-it"),

                        setTimeout(function () {

                            $(".banner-parallax > .bg-element, .banner-parallax > .overlay-pattern").addClass("appeared")

                        }, 1000)

                }, 0)

            }, each: function (a, t, e) {

                var n = Math.floor((a + 1) / t * 100);

                $("#lp-counter").animate({ $this: n }, {

                    duration: 150, easing: "", queue: !1, step: function (a) {

                        var t = Math.round(a);

                        $("#lp-counter").text(t + "%")

                    }

                }), $("#lp-bar").animate({ width: n + "%" }, 0)

            }, waitForAll: !0

        });


        /*=================================== 進頁面載入資料 ======================================*/
        $(function () {
            //載入會員+購物車+優惠券+信用卡資料
            $.get("/dessert_shop/cart/checkoutData", {}, function (data) {
                console.log(data);
                if (data.flag) {
                    //會員
                    let member_name = data.data[4].member_name;
                    if (data.data[4].member_gender == 1) {
                        $("span.show_name").text(member_name + "\t先生");
                    } else {
                        $("span.show_name").text(member_name + "\t小姐");
                    }

                    let show_phone = data.data[4].member_phone;
                    $("span.show_phone").text(show_phone);

                    let show_email = data.data[4].member_email;
                    $("span.show_email").text(show_email);

                    //購物車+優惠券
                    let total_quantity = 0;
                    let total_price = 0;
                    let coupon_price = data.data[5];

                    if (data.data[0].length == 0) {

                        alert("購物車內無商品");
                        location.href = "product-all.html";

                    } else {

                        for (var i = 0; i < data.data[0].length; i++) {

                            let cart_product = `<tr>
                                            <td class="Product-name">
                                                <p>${data.data[0][i].product_name}</p>
                                            </td>
                                            <td class="Product-price">
                                                <p>$${data.data[0][i].product_price} × ${data.data[0][i].product_quantity}</p>
                                            </td>
                                            </tr>`;

                            $("table.cart_table").find("tbody").prepend(cart_product);
                            total_quantity = parseInt(total_quantity) + parseInt(data.data[0][i].product_quantity);
                            total_price = parseInt(total_price) + parseInt(data.data[0][i].product_price * data.data[0][i].product_quantity);
                        }

                        $("p.total_quantity").text("合計數量：" + total_quantity);
                        $("p.total_price").text("合計金額：" + total_price + "元");
                        if (coupon_price != null) {
                            $("p.coupon_price").text("優惠金額：" + coupon_price + "元");
                            let final_price = total_price - coupon_price;
                            $("h3.final_price").text("應付金額：" + final_price + "元");
                            $("h3.final_price").attr("data-final_price", final_price);
                        } else {
                            $("h3.final_price").text("應付金額：" + total_price + "元");
                            $("h3.final_price").attr("data-final_price", total_price);
                        }

                    }

                    //信用卡
                    if (data.data[3].length != 0) {

                        for (var i = 0; i < data.data[3].length; i++) {

                            let card = `<div style="padding-bottom: 5px;"><input type="radio" class="card" id="card-${data.data[3][i].card_id}" name="card_list">
                                        <label style="padding-right: 5px;" for="card-${data.data[3][i].card_id}" data-card_id="${data.data[3][i].card_id}" data-card_number="${data.data[3][i].card_number}" data-card_expired_day="${data.data[3][i].card_expired_day}" data-card_cvc="${data.data[3][i].card_cvc}">
                                        卡號：${data.data[3][i].card_number}</label><button type="button" class="delete_card">刪除</button></div>`;

                            $("div.card_list").append(card);
                        }

                        $("span.card_empty").text("");
                    }



                } else {
                    
                    if (data.redirect) {
                        location.href = data.redirect;
                    }
                }


            });  //get


        });


        /*=================================== 新增信用卡 ======================================*/
        $("button.insert_card").on("click", function () {
            let card_number = $("input#cardnumber").val();
            let card_expired_day = $("input#expirationdate").val();
            let card_cvc = $("input#securitycode").val();

            if (card_number == "" || card_expired_day == "" || card_cvc == "") {
                alert("信用卡資料請勿空白!");
            } else {

                $.post("/dessert_shop/cart/insertCreditCard", { "card_number": card_number, "card_expired_day": card_expired_day, "card_cvc": card_cvc }, function (data) {
                    console.log(data);
                    if (data.flag) {
                        let card = `<div style="padding-bottom: 5px;"><input type="radio" class="card" id="card-${data.data.card_id}" name="card_list">
                                <label style="padding-right: 5px;" for="card-${data.data.card_id}" data-card_id="${data.data.card_id}" data-card_number="${data.data.card_number}" data-card_expired_day="${data.data.card_expired_day}" data-card_cvc="${data.data.card_cvc}">
                                卡號：${data.data.card_number}</label><button type="button" class="delete_card">刪除</button></div>`;

                        $("div.card_list").append(card);

                        $("span.card_empty").text("");

                    } else {
                        alert(data.msg);
                        if (data.redirect) {
                            location.href = data.redirect;
                        }
                    }

                });  //post

            }

        });


        /*=================================== 刪除信用卡 ======================================*/
        $("div.card_list").on("click", "button.delete_card", function () {
            let card_id = $(this).siblings("label").attr("data-card_id");
            let status = $(this).siblings("input").attr("data-status");
            let card = $(this).closest("div");
            $.post("/dessert_shop/cart/deleteCreditCard", { "card_id": card_id }, function (data) {
                console.log(data);
                if (data.flag) {

                    if (status == "checked") {
                        $("a.setOrder").attr("data-payment_method", 0);
                        $("a.setOrder").attr("data-card_number", "none");
                    }

                    card.remove();

                    if ($("div.card_list").children("div").length == 0) {
                        $("span.card_empty").text("(您未有任何信用卡)");
                    }

                } else {
                    alert(data.msg);
                    if (data.redirect) {
                        location.href = data.redirect;
                    }
                }



            });  //post


        });


        /*=================================== 付款方式 ======================================*/
        $("div.card_list").on("click", "input", function () {

            $("a.setOrder").attr("data-payment_method", 1);
            $("a.setOrder").attr("data-card_number", $(this).siblings("label").attr("data-card_number"));
            $("div.card_list").find("input").attr("data-status", "no-checked");
            $(this).attr("data-status", "checked");

        });


        /*=================================== 送出訂單 ======================================*/
        $("a.setOrder").on("click", function () {
            let payment_method = $(this).attr("data-payment_method");
            let order_total = $("h3.final_price").attr("data-final_price");
            let order_remarks = $("textarea.remarks").val();
            let card_number = $(this).attr("data-card_number");
            $.post("/dessert_shop/cart/setOrder", { "payment_method": payment_method, "order_total": order_total, "order_remarks": order_remarks, "card_number": card_number }, function (data) {
                console.log(data);
                if (data.flag) {

                    if (payment_method == 1) {
                        let timerInterval
                        Swal.fire({
                            title: '訂單資料處理中!',
                            timer: 1500,
                            timerProgressBar: false,
                            didOpen: () => {
                                Swal.showLoading()
                                timerInterval = setInterval(() => {
                                    const content = Swal.getContent()
                                    if (content) {
                                        const b = content.querySelector('b')
                                        if (b) {
                                            b.textContent = Swal.getTimerLeft()
                                        }
                                    }
                                }, 100)
                            },
                            willClose: () => {
                                clearInterval(timerInterval)
                            }
                        }).then((result) => {
                            Swal.fire({
                                icon: 'success',
                                title: '付款成功!',
                                showConfirmButton: false,
                                timer: 1000,
                            }).then((result) => {
                                location.href = data.redirect;
                            });

                        });

                    } else if (payment_method == 3) {
                        Swal.fire({
                            icon: 'success',
                            title: '訂單完成!',
                            showConfirmButton: false,
                            timer: 1000
                        }).then(function () {
                            Swal.fire({
                                title: '請匯款至此銀行帳戶：\n\n' + data.data
                            }).then(function () {
                                location.href = data.redirect;
                            });

                        });

                    } else {
                        Swal.fire({
                            icon: 'success',
                            title: '訂單完成!',
                            showConfirmButton: false,
                            timer: 1000
                        }).then(function () {
                            location.href = data.redirect;
                        });

                    }


                } else {
                    alert(data.msg);
                    if (data.redirect) {
                        location.href = data.redirect;
                    }
                }



            });  //post


        });



    </script>


    <!-- 付款方式 -->
    <script>
        $("input#pay1").on("change", function (e) {
            e.preventDefault();
            $(this).siblings("div.form-container").toggleClass("-on");
            $("a.setOrder").attr("data-payment_method", 0);
            $("a.setOrder").attr("data-card_number", "none");
            $("div.card_list").find("input").each(function () {
                if ($(this).attr("data-status") == "checked")
                    $("a.setOrder").attr("data-payment_method", 1);
                $("a.setOrder").attr("data-card_number", $(this).siblings("label").attr("data-card_number"));
            });

        });

        $("input#pay2").on("change", function (e) {
            e.preventDefault();
            $(this).siblings("div.form-container").addClass("-on");
            $("a.setOrder").attr("data-payment_method", 2);
            $("a.setOrder").attr("data-card_number", "none");
        });

        $("input#pay3").on("change", function (e) {
            e.preventDefault();
            $(this).siblings("div.form-container").addClass("-on");
            $("a.setOrder").attr("data-payment_method", 3);
            $("a.setOrder").attr("data-card_number", "none");
        });

    </script>



</body>

</html>